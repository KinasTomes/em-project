# ==============================================================================
# E-COMMERCE MICROSERVICES - DOCKER COMPOSE
# ==============================================================================
# Defines the services, networks, and volumes for the entire application stack.
# To run:
# 1. Copy .env.example to .env and fill in the values.
# 2. Run `docker compose up --build`
# ==============================================================================

services:
  #----------------------------------------------------------------
  # 1. API Gateway Service
  #----------------------------------------------------------------
  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    ports:
      - "${API_GATEWAY_PORT:-3003}:3003"
    environment:
      - DISABLE_RATE_LIMIT=true # ONLY FOR DEVELOPMENT
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${API_GATEWAY_PORT:-3003}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://auth:3001}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL:-http://product:3004}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://order:3002}
      - INVENTORY_SERVICE_URL=${INVENTORY_SERVICE_URL:-http://inventory:3005}
      - SECKILL_SERVICE_URL=${SECKILL_SERVICE_URL:-http://seckill:3007}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - auth
      - product
      - order
      - seckill
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 2. Auth Service
  #----------------------------------------------------------------
  auth:
    build:
      context: .
      dockerfile: ./services/auth/Dockerfile
    ports:
      - "${AUTH_PORT:-3001}:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${AUTH_PORT:-3001}
      - MONGODB_AUTH_URI=${MONGODB_AUTH_URI}
      - JWT_SECRET=${JWT_SECRET}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
    depends_on:
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 3. Product Service
  #----------------------------------------------------------------
  product:
    build:
      context: .
      dockerfile: ./services/product/Dockerfile
    ports:
      - "${PRODUCT_PORT:-3004}:3004"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PRODUCT_PORT:-3004}
      - MONGODB_PRODUCT_URI=${MONGODB_PRODUCT_URI}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://rabbitmq:5672}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - INVENTORY_URL=${INVENTORY_URL:-http://inventory:3005}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - inventory
      - rabbitmq
      - redis
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 4. Order Service
  #----------------------------------------------------------------
  order:
    build:
      context: .
      dockerfile: ./services/order/Dockerfile
    ports:
      - "${ORDER_PORT:-3002}:3002"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${ORDER_PORT:-3002}
      - MONGODB_ORDER_URI=${MONGODB_ORDER_URI}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://rabbitmq:5672}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - EXCHANGE_NAME=${EXCHANGE_NAME:-ecommerce.events}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - rabbitmq
      - redis
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 5. Inventory Service
  #----------------------------------------------------------------
  inventory:
    build:
      context: .
      dockerfile: ./services/inventory/Dockerfile
    ports:
      - "${INVENTORY_PORT:-3005}:3005"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${INVENTORY_PORT:-3005}
      - MONGODB_INVENTORY_URI=${MONGODB_INVENTORY_URI}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://rabbitmq:5672}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - EXCHANGE_NAME=${EXCHANGE_NAME:-ecommerce.events}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - rabbitmq
      - redis
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 6. Payment Service
  #----------------------------------------------------------------
  payment:
    build:
      context: .
      dockerfile: ./services/payment/Dockerfile
    ports:
      - "${PAYMENT_PORT:-3006}:3006"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PAYMENT_PORT:-3006}
      - PAYMENT_PORT=${PAYMENT_PORT:-3006}
      - PAYMENT_SUCCESS_RATE=${PAYMENT_SUCCESS_RATE:-0.9}
      - MONGODB_PAYMENT_URI=${MONGODB_PAYMENT_URI}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://rabbitmq:5672}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - EXCHANGE_NAME=${EXCHANGE_NAME:-ecommerce.events}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
    depends_on:
      - rabbitmq
      - redis
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 7. Seckill Service (Flash Sale)
  #----------------------------------------------------------------
  seckill:
    build:
      context: .
      dockerfile: ./services/seckill/Dockerfile
    ports:
      - "${SECKILL_PORT:-3007}:3007"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${SECKILL_PORT:-3007}
      - SECKILL_PORT=${SECKILL_PORT:-3007}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://rabbitmq:5672}
      - REDIS_SECKILL_URL=${REDIS_SECKILL_URL:-redis://redis-seckill:6380}
      - EXCHANGE_NAME=${EXCHANGE_NAME:-ecommerce.events}
      - JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-http://jaeger:4318/v1/traces}
      - SECKILL_ADMIN_KEY=${SECKILL_ADMIN_KEY:-seckill-admin-key}
      - SECKILL_RATE_LIMIT=${SECKILL_RATE_LIMIT:-5}
      - SECKILL_RATE_WINDOW=${SECKILL_RATE_WINDOW:-1}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - rabbitmq
      - redis-seckill
      - jaeger
    networks:
      - ecommerce-network

  #----------------------------------------------------------------
  # 8. INFRASTRUCTURE
  #----------------------------------------------------------------
  # # Redis for Idempotency and Caching
  # redis:
  #   image: redis:7-alpine
  #   container_name: 'redis'
  #   ports:
  #     - "6379:6379"
  #   networks:
  #     - ecommerce-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5

  # RabbitMQ for Message Brokering
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: 'rabbitmq'
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Jaeger for Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: 'jaeger'
    ports:
      - "16686:16686" # Jaeger UI
      - "4318:4318"   # OTLP HTTP receiver
    networks:
      - ecommerce-network
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  # Redis for Caching
  redis:
    image: redis:7-alpine
    container_name: 'redis'
    ports:
      - "6379:6379"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Dedicated Redis for Seckill Service (Flash Sale)
  # Configured with noeviction policy and AOF persistence for data durability
  # Requirements: 9.1, 9.2, 9.3
  redis-seckill:
    image: redis:7-alpine
    container_name: 'redis-seckill'
    ports:
      - "6380:6380"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6380", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - redis_seckill_data:/data
    command: >
      redis-server
      --port 6380
      --maxmemory-policy noeviction
      --appendonly yes
      --appendfsync everysec

#----------------------------------------------------------------
# 9. NETWORKS & VOLUMES
#----------------------------------------------------------------
networks:
  ecommerce-network:
    driver: bridge

volumes:
  redis_data:
  redis_seckill_data:
